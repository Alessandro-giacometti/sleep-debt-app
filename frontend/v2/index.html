<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleep Debt Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõèÔ∏è</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- CSS Modulare -->
    <link rel="stylesheet" href="/static/v2/styles/variables.css">
    <link rel="stylesheet" href="/static/v2/styles/base.css">
    <link rel="stylesheet" href="/static/v2/styles/components.css">
    <link rel="stylesheet" href="/static/v2/styles/pages.css">
</head>
<body>
    <!-- Homepage -->
    <div id="homepage" class="homepage">
        <div class="container">
            <div class="header">
                <div class="header-top">
                    <div class="header-left">
                        <h1 class="header-title">üò¥ Sleep Debt Tracker</h1>
                        <p class="header-subtitle">Monitora il tuo debito di sonno</p>
                    </div>
                    <div class="header-right">
                        <div class="header-date" id="header-date"></div>
                    </div>
                </div>
            </div>

            <!-- Avviso Nessun Dato -->
            <div class="card no-data-warning" id="no-data-warning" style="display: none;">
                <div class="no-data-warning-content">
                    <span class="no-data-warning-icon">‚ö†Ô∏è</span>
                    <span class="no-data-warning-text">Non ci sono dati. Avvia la sincronizzazione con il pulsante qui sotto</span>
                </div>
            </div>

            <!-- Avviso Sincronizzazione in Corso -->
            <div class="card syncing-today-warning" id="syncing-today-warning" style="display: none;">
                <div class="syncing-today-warning-content">
                    <span class="syncing-today-warning-icon">‚è≥</span>
                    <div class="syncing-today-warning-text">
                        <strong>Sincronizzazione in corso...</strong>
                        <p>Sto recuperando i dati di sonno di oggi da Garmin.</p>
                    </div>
                </div>
            </div>

            <!-- Avviso Dato Oggi Mancante -->
            <div class="card missing-today-warning" id="missing-today-warning" style="display: none;">
                <div class="missing-today-warning-content">
                    <span class="missing-today-warning-icon">‚ö†Ô∏è</span>
                    <div class="missing-today-warning-text">
                        <strong>Dati sonno mancanti</strong>
                        <p id="missing-today-message"></p>
                    </div>
                </div>
            </div>

            <!-- Avviso Dati Insufficienti per Finestra -->
            <div class="card insufficient-data-warning" id="insufficient-data-warning" style="display: none;">
                <div class="insufficient-data-warning-content">
                    <span class="insufficient-data-warning-icon">‚ö†Ô∏è</span>
                    <div class="insufficient-data-warning-text">
                        <strong>Dati insufficienti</strong>
                        <p id="insufficient-data-message"></p>
                    </div>
                </div>
            </div>

            <!-- Card Debito Principale -->
            <div class="card debt-main-card" id="debt-main-card">
                <button class="sync-btn-inline" id="sync-btn" onclick="syncData()">üîÑ</button>
                <div class="debt-label">
                    <span class="debt-label-icon">üõèÔ∏è</span>
                    <span>Sleep Debt</span>
                </div>
                <div class="debt-value" id="debt-value">-</div>
            </div>

            <!-- Mini Card Zona e Target -->
            <div class="mini-cards">
                <div class="mini-card" onclick="showZonePage()">
                    <div class="mini-card-content">
                        <div class="mini-card-label">Sleep Debt Zone</div>
                        <div class="mini-card-value" id="current-zone">-</div>
                    </div>
                    <div class="mini-card-chevron">‚Ä∫</div>
                </div>
                <div class="mini-card" onclick="openTargetSettings()">
                    <div class="mini-card-content">
                        <div class="mini-card-label">Target sonno giornaliero</div>
                        <div class="mini-card-value" id="target-sleep">-</div>
                    </div>
                    <div class="mini-card-chevron">‚Ä∫</div>
                </div>
            </div>

            <!-- Grafico -->
            <div class="card chart-section">
                <div class="chart-header" onclick="openChartFullscreen()">
                    <div class="chart-title">
                        <span id="chart-title-text">Andamento del debito di sonno</span>
                        <span class="chart-title-chevron">‚Ä∫</span>
                    </div>
                    <span class="chart-toggle-icon" onclick="event.stopPropagation(); switchChartType()" style="font-size: 20px; cursor: pointer; opacity: 0.6;">üìä</span>
                </div>
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>

            <!-- Card Dormi Oggi e Daily Change -->
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-card-content">
                        <div class="info-card-label">Ore dormite oggi</div>
                        <div class="info-card-value" id="today-sleep">-</div>
                    </div>
                    <div class="info-card-chevron">‚Ä∫</div>
                </div>
                <div class="info-card" onclick="showDailyChangePage()">
                    <div class="info-card-content">
                        <div class="info-card-label">Daily Change</div>
                        <div class="info-card-value" id="today-change">-</div>
                    </div>
                    <span class="info-card-chevron">‚Ä∫</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagina Impostazioni -->
    <div id="settings-page" class="settings-page">
        <div class="container">
            <div class="header">
                <h1 class="header-title">Impostazioni</h1>
            </div>

            <div class="settings-list">
                <div class="settings-row" onclick="showSettingsSubpage('window')">
                    <span class="settings-row-label">Finestra mobile del debito</span>
                    <div class="settings-row-value">
                        <span id="settings-window-value">7 giorni</span>
                        <span class="settings-row-chevron">‚Ä∫</span>
                    </div>
                </div>
                <div class="settings-row" onclick="showSettingsSubpage('target')">
                    <span class="settings-row-label">Target sonno giornaliero</span>
                    <div class="settings-row-value">
                        <span id="settings-target-value">8h 00m</span>
                        <span class="settings-row-chevron">‚Ä∫</span>
                    </div>
                </div>
                <div class="settings-row settings-row-toggle">
                    <span class="settings-row-label">UI V1</span>
                    <div class="settings-row-value">
                        <a href="/ui/v1" class="settings-toggle-switch">
                            <div class="settings-toggle-switch-slider"></div>
                        </a>
                    </div>
                </div>
                <div class="settings-row settings-row-danger" onclick="confirmDeleteAllData()">
                    <span class="settings-row-label">Elimina tutti i dati</span>
                    <div class="settings-row-value">
                        <span class="settings-row-chevron">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sotto-pagina Finestra -->
    <div id="settings-window-subpage" class="settings-subpage">
        <div class="settings-subpage-header">
            <button class="settings-subpage-back" onclick="closeSettingsSubpage()">‚Äπ</button>
            <h2 class="settings-subpage-title">Finestra giorni di calcolo</h2>
        </div>
        
        <div class="window-settings-content">
            <!-- Sezione Finestra Calcolo -->
            <div class="window-section">
                <div class="window-section-title">FINESTRA DI CALCOLO DEBITO SONNO</div>
                <div class="window-options-card">
                    <div class="window-option" onclick="selectWindow(7)">
                        <span class="window-option-label">7 giorni</span>
                        <span class="window-option-check" id="window-check-7"></span>
                    </div>
                    <div class="window-option" onclick="selectWindow(10)">
                        <span class="window-option-label">10 giorni <span class="window-option-recommended">(Raccomandato)</span></span>
                        <span class="window-option-check" id="window-check-10">‚úì</span>
                    </div>
                    <div class="window-option" onclick="selectWindow(14)">
                        <span class="window-option-label">14 giorni</span>
                        <span class="window-option-check" id="window-check-14"></span>
                    </div>
                </div>
                <div class="window-section-description">
                    La finestra di calcolo definisce quanti giorni recenti vengono utilizzati per determinare il debito di sonno attuale. Una finestra di 7 giorni risulta molto reattiva alle variazioni recenti del sonno, mentre una finestra di 14 giorni garantisce maggiore stabilit√†, evidenziando le tendenze a lungo termine. La finestra di 10 giorni consigliata rappresenta un equilibrio ottimale tra sensibilit√† e stabilit√† per la maggior parte degli utenti.
                </div>
            </div>

            <!-- Sezione Metodo Calcolo -->
            <div class="window-section">
                <div class="window-section-title">METODO DI CALCOLO</div>
                <div class="window-method-card">
                    <div class="window-method-row">
                        <span class="window-method-label">Valuta di pi√π gli ultimi giorni</span>
                        <div class="window-method-toggle" onclick="toggleWeight()">
                            <div class="window-method-toggle-slider" id="weight-toggle-slider"></div>
                        </div>
                    </div>
                </div>
                <div class="window-section-description">
                    I calcoli ponderati rappresentano in modo pi√π accurato come il corpo recupera il sonno perso, dando maggiore importanza ai giorni pi√π recenti. Disattivando questa opzione, tutti i giorni nella finestra avranno lo stesso peso, semplificando il calcolo.
                </div>
            </div>
        </div>

        <div class="settings-subpage-actions">
            <button class="settings-save-btn" id="settings-save-btn-window" onclick="saveSettings()">Salva</button>
        </div>
        <div class="settings-message" id="settings-message-window"></div>
    </div>

    <!-- Sotto-pagina Obiettivo -->
    <div id="settings-target-subpage" class="settings-subpage">
        <div class="settings-subpage-header">
            <button class="settings-subpage-back" onclick="closeSettingsSubpage()">‚Äπ</button>
            <h2 class="settings-subpage-title">Target sonno giornaliero</h2>
        </div>
            <div class="target-picker-container">
            <div class="target-picker-label-top">IMPOSTA OBIETTIVO SONNO:</div>
            <div class="target-picker-main">
                <div class="target-picker-scrollable">
                    <div class="target-picker-scroll-wrapper" id="target-hours-scroll">
                        <div class="target-picker-scroll-content" id="target-hours-content"></div>
                    </div>
                    <div class="target-picker-scroll-wrapper" id="target-minutes-scroll">
                        <div class="target-picker-scroll-content" id="target-minutes-content"></div>
                    </div>
                </div>
                <div class="target-picker-separator"></div>
                <div class="target-picker-selected" id="target-picker-selected">Selezionato: 8h 00min</div>
            </div>
            <div class="target-picker-info">
                Secondo gli studi scientifici, la durata ottimale del riposo per gli adulti si colloca tra le 7 e le 9 ore. Un obiettivo di 8 ore costituisce una scelta ideale se non conosci ancora le tue esigenze personali.
            </div>
        </div>
        <div class="settings-subpage-actions">
            <button class="settings-save-btn" id="settings-save-btn-target" onclick="saveSettings()">Salva</button>
        </div>
        <div class="settings-message" id="settings-message-target"></div>
    </div>

    <!-- Pagina Zone Debito -->
    <div id="zone-page" class="zone-page">
        <div class="zone-page-header">
            <button class="zone-page-back" onclick="closeZonePage()">‚Äπ</button>
            <h2 class="zone-page-title">Sleep Debt Zone</h2>
        </div>

        <div class="zone-main-card">
            <div class="zone-main-label">Debito di sonno attuale</div>
            <div class="zone-main-value" id="zone-main-value">-</div>
            <div class="zone-progress-bar" id="zone-progress-bar">
                <div class="zone-progress-slider" id="zone-progress-slider"></div>
            </div>
            <div class="zone-progress-markers">
                <div class="zone-progress-marker" style="left: 20%;">
                    <div class="zone-progress-marker-dot" style="background: var(--color-yellow);"></div>
                    <div class="zone-progress-marker-label">6h</div>
                </div>
                <div class="zone-progress-marker" style="left: 43.33%;">
                    <div class="zone-progress-marker-dot" style="background: var(--color-orange);"></div>
                    <div class="zone-progress-marker-label">13h</div>
                </div>
                <div class="zone-progress-marker" style="left: 80%;">
                    <div class="zone-progress-marker-dot" style="background: var(--color-red);"></div>
                    <div class="zone-progress-marker-label">24h</div>
                </div>
            </div>
        </div>

        <div class="zone-list">
            <div class="zone-item expanded" onclick="toggleZoneItem(this)">
                <div class="zone-item-header">
                    <div class="zone-item-left">
                        <div class="zone-item-icon optimal">‚úì</div>
                        <div>
                            <div class="zone-item-title">Ottimale</div>
                            <div class="zone-item-range">(&lt; 6 h)</div>
                        </div>
                    </div>
                    <span class="zone-item-chevron">‚Ä∫</span>
                </div>
                <div class="zone-item-content">
                    Il tuo debito di sonno √® nella zona ottimale. Le tue prestazioni cognitive e fisiche sono al massimo livello.
                </div>
            </div>
            <div class="zone-item" onclick="toggleZoneItem(this)">
                <div class="zone-item-header">
                    <div class="zone-item-left">
                        <div class="zone-item-icon slight"></div>
                        <div>
                            <div class="zone-item-title">Lieve deficit</div>
                            <div class="zone-item-range">(6h - 13h)</div>
                        </div>
                    </div>
                    <span class="zone-item-chevron">‚Ä∫</span>
                </div>
                <div class="zone-item-content">
                    Il tuo debito di sonno √® lieve. Potresti notare una leggera riduzione dell'energia durante la giornata.
                </div>
            </div>
            <div class="zone-item" onclick="toggleZoneItem(this)">
                <div class="zone-item-header">
                    <div class="zone-item-left">
                        <div class="zone-item-icon large"></div>
                        <div>
                            <div class="zone-item-title">Deficit moderato</div>
                            <div class="zone-item-range">(13h - 24h)</div>
                        </div>
                    </div>
                    <span class="zone-item-chevron">‚Ä∫</span>
                </div>
                <div class="zone-item-content">
                    Il tuo debito di sonno √® moderato. Le tue prestazioni cognitive e fisiche potrebbero essere compromesse.
                </div>
            </div>
            <div class="zone-item" onclick="toggleZoneItem(this)">
                <div class="zone-item-header">
                    <div class="zone-item-left">
                        <div class="zone-item-icon critical"></div>
                        <div>
                            <div class="zone-item-title">Deficit elevato</div>
                            <div class="zone-item-range">(24h+)</div>
                        </div>
                    </div>
                    <span class="zone-item-chevron">‚Ä∫</span>
                </div>
                <div class="zone-item-content">
                    Il tuo debito di sonno √® elevato. √à importante recuperare il riposo per evitare conseguenze sulla salute e le prestazioni.
                </div>
            </div>
        </div>
    </div>

    <!-- Pagina Daily Change -->
    <div id="daily-change-page" class="daily-change-page">
        <div class="daily-change-page-header">
            <button class="daily-change-page-back" onclick="closeDailyChangePage()">‚Äπ</button>
            <h2 class="daily-change-page-title">Daily Change</h2>
        </div>

        <div class="daily-change-content">
            <div class="card">
                <div class="daily-change-target-info" id="daily-change-target-info">
                    Target sonno: <span id="daily-change-target-value">-</span>
                </div>
                <div class="daily-change-table-container">
                    <table class="daily-change-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Durata Sonno</th>
                                <th>Differenza</th>
                                <th>Debito Sonno</th>
                            </tr>
                        </thead>
                        <tbody id="daily-change-table-body">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: var(--color-text-secondary);">
                                    Caricamento dati...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagina Grafico Fullscreen -->
    <div id="chart-fullscreen" class="chart-fullscreen">
        <div class="chart-fullscreen-header">
            <button class="chart-fullscreen-back" onclick="closeChartFullscreen()">‚Äπ</button>
            <h2 class="chart-fullscreen-title">Sleep Debt Trend</h2>
        </div>

        <div class="chart-fullscreen-container">
            <canvas id="fullscreen-chart"></canvas>
        </div>

        <div class="chart-fullscreen-bar-container">
            <div class="chart-fullscreen-bar" id="chart-fullscreen-bar">
                <div class="chart-fullscreen-bar-marker" style="left: 0%;">
                    <div class="chart-fullscreen-bar-marker-dot"></div>
                    <div class="chart-fullscreen-bar-marker-label">6 h</div>
                </div>
                <div class="chart-fullscreen-bar-marker" style="left: 50%;">
                    <div class="chart-fullscreen-bar-marker-dot"></div>
                    <div class="chart-fullscreen-bar-marker-label">13 h e 30 min</div>
                </div>
                <div class="chart-fullscreen-bar-marker" style="left: 100%;">
                    <div class="chart-fullscreen-bar-marker-dot"></div>
                    <div class="chart-fullscreen-bar-marker-label">24 h e 23 min</div>
                </div>
            </div>
        </div>

        <div class="chart-fullscreen-selector">
            <button class="chart-fullscreen-selector-btn" id="chart-btn-7" onclick="selectDays(7)">7 Giorni</button>
            <button class="chart-fullscreen-selector-btn" id="chart-btn-10" onclick="selectDays(10)">10 Giorni</button>
            <button class="chart-fullscreen-selector-btn" id="chart-btn-14" onclick="selectDays(14)">14 Giorni</button>
            <button class="chart-fullscreen-selector-btn" id="chart-btn-30" onclick="selectDays(30)">30 Giorni</button>
            <button class="chart-fullscreen-selector-btn" id="chart-btn-90" onclick="selectDays(90)">90 Giorni</button>
            <span class="chart-fullscreen-selector-icon" onclick="event.stopPropagation(); switchChartType()">üìä</span>
        </div>
    </div>

    <!-- Modal Conferma Eliminazione Dati -->
    <div id="delete-confirm-modal" class="delete-confirm-modal">
        <div class="delete-confirm-modal-content">
            <div class="delete-confirm-modal-header">
                <h3>‚ö†Ô∏è Conferma Eliminazione</h3>
            </div>
            <div class="delete-confirm-modal-body">
                <p>Sei sicuro di voler eliminare <strong>tutti i dati di sonno</strong>? Questa azione √® <strong>irreversibile</strong> e non pu√≤ essere annullata.</p>
                <p style="color: var(--color-red); font-weight: 600; margin-top: var(--spacing-md);">Tutti i dati storici verranno persi definitivamente.</p>
            </div>
            <div class="delete-confirm-modal-actions">
                <button class="delete-confirm-modal-btn delete-confirm-modal-btn-cancel" onclick="cancelDeleteAllData()">Annulla</button>
                <button class="delete-confirm-modal-btn delete-confirm-modal-btn-confirm" id="confirm-delete-btn" onclick="deleteAllData()">S√¨, Elimina Tutto</button>
            </div>
        </div>
    </div>

    <!-- Modal Sincronizzazione Grafico -->
    <div id="chart-sync-modal" class="chart-sync-modal">
        <div class="chart-sync-modal-content">
            <div class="chart-sync-modal-header">
                <h3>Dati insufficienti</h3>
            </div>
            <div class="chart-sync-modal-body">
                <p id="chart-sync-modal-message"></p>
            </div>
            <div class="chart-sync-modal-actions">
                <button class="chart-sync-modal-btn chart-sync-modal-btn-cancel" onclick="closeSyncPromptModal()">Annulla</button>
                <button class="chart-sync-modal-btn chart-sync-modal-btn-confirm" onclick="confirmChartSync()">Sincronizza</button>
            </div>
        </div>
    </div>

    <!-- Navbar Inferiore -->
    <nav class="navbar-bottom">
        <button class="navbar-item active" onclick="showHomepage()">
            <span class="navbar-icon">üè†</span>
            <span>Home</span>
        </button>
        <button class="navbar-item" onclick="showSettings()">
            <span class="navbar-icon">‚öôÔ∏è</span>
            <span>Impostazioni</span>
        </button>
    </nav>

    <!-- JavaScript Modulare -->
    <script src="/static/v2/app.js"></script>
    <script src="/static/v2/js/navigation.js"></script>
    <script src="/static/v2/js/pages/homepage.js"></script>
    <script src="/static/v2/js/pages/settings.js"></script>
    <script src="/static/v2/js/pages/zone.js"></script>
    <script src="/static/v2/js/pages/chart.js"></script>
    <script src="/static/v2/js/pages/daily-change.js"></script>
    <script src="/static/v2/charts.js"></script>
</body>
</html>
